<div class="space-y-10 animate-fadeIn pb-16">
    <!-- Breadcrumbs / Header -->
    <div class="flex flex-col md:flex-row md:items-start justify-between gap-6">
        <div class="flex items-center gap-6">
            <div
                class="h-16 w-16 rounded-2xl bg-slate-900 flex items-center justify-center text-white font-black text-2xl shadow-xl shadow-slate-200 dark:shadow-none dark:bg-white dark:text-slate-900 group-hover:scale-110 transition-transform">
                <%= project.name.charAt(0).toUpperCase() %>
            </div>
            <div>
                <nav
                    class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">
                    <a href="/projects"
                        class="hover:text-slate-900 dark:hover:text-white transition-colors">Projects</a>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span class="text-slate-900 dark:text-white">
                        <%= project.name %>
                    </span>
                </nav>
                <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tighter">
                    <%= project.name %>
                </h1>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="confirmDeleteProject()"
                class="px-5 py-2.5 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-600 hover:text-white transition-saas dark:bg-red-500/10 dark:text-red-400 dark:hover:bg-red-500 dark:hover:text-white">
                Delete Project
            </button>
        </div>
    </div>

    <!-- Sub-Navigation -->
    <div class="flex items-center gap-8 border-b border-slate-200 dark:border-white/5 no-scrollbar overflow-x-auto">
        <button onclick="switchTab('overview')" id="tab-overview"
            class="tab-btn px-1 py-4 text-sm font-bold text-slate-400 relative transition-colors hover:text-slate-900 dark:hover:text-white">
            Overview
            <div
                class="tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white transform scale-x-0 transition-transform">
            </div>
        </button>
        <button onclick="switchTab('apikeys')" id="tab-apikeys"
            class="tab-btn px-1 py-4 text-sm font-bold text-slate-400 relative transition-colors hover:text-slate-900 dark:hover:text-white">
            API Keys
            <div
                class="tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white transform scale-x-0 transition-transform">
            </div>
        </button>
        <button onclick="switchTab('logs')" id="tab-logs"
            class="tab-btn px-1 py-4 text-sm font-bold text-slate-400 relative transition-colors hover:text-slate-900 dark:hover:text-white">
            Audit Logs
            <div
                class="tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white transform scale-x-0 transition-transform">
            </div>
        </button>
        <button onclick="switchTab('settings')" id="tab-settings"
            class="tab-btn px-1 py-4 text-sm font-bold text-slate-400 relative transition-colors hover:text-slate-900 dark:hover:text-white">
            Settings
            <div
                class="tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white transform scale-x-0 transition-transform">
            </div>
        </button>
    </div>

    <!-- Sections -->
    <div id="content-overview" class="tab-content animate-fadeIn space-y-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="card p-8 bg-slate-50 dark:bg-white/5 border-none shadow-none">
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">Lifetime Activity</p>
                <h3 class="text-3xl font-extrabold text-slate-900 dark:text-white tabular-nums">
                    <%= project.apiKeys.reduce((acc, k)=> acc + (k.usage?.count || 0), 0).toLocaleString() %>
                </h3>
            </div>
            <div class="card p-8 bg-slate-50 dark:bg-white/5 border-none shadow-none">
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">Health Status</p>
                <h3 class="text-3xl font-extrabold text-emerald-500 tabular-nums">99.9%</h3>
            </div>
            <div class="card p-8 bg-slate-50 dark:bg-white/5 border-none shadow-none">
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">Response Latency</p>
                <h3 class="text-3xl font-extrabold text-slate-900 dark:text-white tabular-nums">12ms</h3>
            </div>
        </div>

        <div class="card p-10">
            <div class="flex items-center justify-between mb-10">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white tracking-tight">Traffic Distribution</h3>
                <div class="flex bg-slate-100 dark:bg-white/5 p-1 rounded-xl">
                    <button onclick="updateChart('24h')"
                        class="chart-btn px-4 py-1.5 text-[10px] font-black uppercase tracking-widest rounded-lg transition-saas">24h</button>
                    <button onclick="updateChart('7d')"
                        class="chart-btn px-4 py-1.5 text-[10px] font-black uppercase tracking-widest rounded-lg transition-saas">7d</button>
                    <button onclick="updateChart('30d')"
                        class="chart-btn px-4 py-1.5 text-[10px] font-black uppercase tracking-widest rounded-lg transition-saas">30d</button>
                </div>
            </div>
            <div class="h-[400px]">
                <canvas id="usageChart"></canvas>
            </div>
        </div>
    </div>

    <div id="content-apikeys" class="tab-content hidden animate-fadeIn space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white tracking-tight">Security Credentials</h2>
            <button onclick="openGenerateModal()" class="btn-primary">Generate Secret Key</button>
        </div>
        <div class="card divide-y dark:divide-white/5">
            <% project.apiKeys.forEach(key=> { %>
                <div class="p-6 flex items-center justify-between group">
                    <div class="space-y-1">
                        <p class="text-sm font-bold text-slate-900 dark:text-white">
                            <%= key.name %>
                        </p>
                        <div class="flex items-center gap-3">
                            <code
                                class="text-[11px] font-mono bg-slate-100 dark:bg-white/5 px-2 py-1 rounded text-slate-500"><%= key.key.substring(0, 12) %>••••••••</code>
                            <button onclick="copyKey('<%= key.key %>')"
                                class="text-[10px] font-black uppercase tracking-widest text-indigo-500">Copy</button>
                        </div>
                    </div>
                    <button onclick="revokeKey('<%= project._id %>', '<%= key._id %>')"
                        class="p-2 text-slate-300 hover:text-red-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
                <% }); %>
        </div>
    </div>

    <div id="content-logs" class="tab-content hidden animate-fadeIn space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white tracking-tight">Audit Logs</h2>
            <button onclick="loadLogs()"
                class="text-xs font-bold uppercase tracking-widest text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">Sync
                Logs</button>
        </div>
        <div class="card overflow-hidden">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-slate-50 dark:bg-white/5 border-b border-slate-200 dark:border-white/5">
                        <th class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Identity
                        </th>
                        <th class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Action
                        </th>
                        <th class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Origin
                        </th>
                        <th class="px-8 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400">Timestamp
                        </th>
                    </tr>
                </thead>
                <tbody id="logsBody" class="divide-y dark:divide-white/5">
                    <tr>
                        <td colspan="4"
                            class="px-8 py-12 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">
                            Awaiting stream...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="content-settings" class="tab-content hidden animate-fadeIn space-y-10">
        <div class="card p-10 max-w-2xl">
            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-8 tracking-tight">Project Settings</h3>
            <form class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Project Label</label>
                    <input type="text" value="<%= project.name %>" class="input-clean" disabled>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Manifest
                        Description</label>
                    <textarea class="input-clean bg-slate-50 dark:bg-white/5"
                        rows="4"><%= project.description %></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Apply Configuration</button>
            </form>
        </div>
    </div>
</div>

<!-- Generate Key Modal -->
<div id="generateKeyModal" class="fixed inset-0 z-[100] hidden">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-md" onclick="closeGenerateModal()"></div>
    <div
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-10 bg-white dark:bg-[#111] rounded-3xl shadow-2xl animate-fadeIn">
        <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-2 tracking-tighter">New Secret Key</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-8 font-medium">Create a new key for this project.</p>

        <form action="/projects/<%= project._id %>/generate-key" method="POST" class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] font-black uppercase tracking-widest text-slate-400">Key Context</label>
                <input type="text" name="name" placeholder="e.g. Staging Server" required class="input-clean">
            </div>
            <div class="flex gap-4">
                <button type="button" onclick="closeGenerateModal()" class="btn-secondary flex-1">Cancel</button>
                <button type="submit" class="btn-primary flex-1">Generate Key</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let usageChart = null;

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('content-' + tabId).classList.remove('hidden');

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('text-slate-900', 'dark:text-white');
            btn.querySelector('.tab-indicator').classList.add('scale-x-0');
        });

        const active = document.getElementById('tab-' + tabId);
        active.classList.add('text-slate-900', 'dark:text-white');
        active.querySelector('.tab-indicator').classList.remove('scale-x-0');

        if (tabId === 'logs') loadLogs();
    }

    async function loadLogs() {
        const body = document.getElementById('logsBody');
        try {
            const res = await fetch(`/projects/<%= project._id %>/logs`);
            const data = await res.json();
            if (!data.logs || data.logs.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="px-8 py-12 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">No activity recorded for this project yet.</td></tr>';
                return;
            }
            body.innerHTML = data.logs.map(log => `
                <tr class="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                    <td class="px-8 py-5 text-xs text-slate-500 font-bold">${log.ip || '0.0.0.0'}</td>
                    <td class="px-8 py-5">
                        <span class="badge ${log.type === 'verify' ? 'badge-success' : 'badge-indigo'}">${log.type}</span>
                    </td>
                    <td class="px-8 py-5 text-[10px] font-black font-mono text-slate-400 uppercase tracking-widest truncate max-w-[100px]">${log.keyId}</td>
                    <td class="px-8 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">${new Date(log.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');
        } catch (e) {
            body.innerHTML = '<tr><td colspan="4" class="px-8 py-12 text-center text-red-500 font-bold">Failed to synchronize audit stream.</td></tr>';
        }
    }

    async function updateChart(period) {
        document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('bg-white', 'dark:bg-white/10', 'text-slate-900', 'dark:text-white', 'shadow-sm'));
        event.target.classList.add('bg-white', 'dark:bg-white/10', 'text-slate-900', 'dark:text-white', 'shadow-sm');

        try {
            const res = await fetch(`/projects/<%= project._id %>/stats?period=` + period);
            const data = await res.json();

            if (!data || data.length === 0) {
                usageChart.data.labels = ['No Data'];
                usageChart.data.datasets[0].data = [0];
            } else {
                usageChart.data.labels = data.map(s => s._id);
                usageChart.data.datasets[0].data = data.map(s => s.count);
            }
            usageChart.update();
        } catch (e) { }
    }

    // Chart Init
    window.addEventListener('load', () => {
        const ctx = document.getElementById('usageChart').getContext('2d');
        usageChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: '#000',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: {
                        beginAtZero: true,
                        grid: { display: false },
                        ticks: { display: false }
                    }
                }
            }
        });
        updateChart('24h');
        switchTab('overview');
    });

    function openGenerateModal() { document.getElementById('generateKeyModal').classList.remove('hidden'); }
    function closeGenerateModal() { document.getElementById('generateKeyModal').classList.add('hidden'); }
    function copyKey(val) { navigator.clipboard.writeText(val); alert('Copied'); }
</script>